<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cocina</title>

<style>
body{
  background:#050505;
  color:#f5d28a;
  font-family:Arial;
  padding:12px;
}

.card{
  background:#101010;
  border:1px solid #2b2b2b;
  padding:14px;
  border-radius:14px;
  margin-bottom:14px;
}

button{
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  margin-top:6px;
}

.preparando{
  background:linear-gradient(145deg, #d8b14a, #b58c2f);
  color:black;
}

.listo{
  background:#0f8f0f;
  color:white;
}
</style>
</head>
<body>

<h1>Panel Cocina</h1>

<audio id="alerta" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="click" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div id="pedidos"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCa-R6z76qoMt6Wf9EZFSqqGNY8U4JUMtM",
  authDomain: "menu-pro-app.firebaseapp.com",
  projectId: "menu-pro-app",
  storageBucket: "menu-pro-app.firebasestorage.app",
  messagingSenderId: "42917274964",
  appId: "1:42917274964:web:3be3c9c124b9c69b8994c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const contenedor = document.getElementById("pedidos");
const sonido = document.getElementById("alerta");
const click = document.getElementById("click");

let pedidosActuales = [];

/* SONIDO BOTONES */
document.addEventListener("click", e=>{
  if(e.target.tagName === "BUTTON") click.play();
});

/* ESCUCHAR PEDIDOS */
onSnapshot(collection(db,"pedidos"), snap=>{
  contenedor.innerHTML = [];

  let nuevos = [];

  snap.forEach(d=>{
    const data = d.data();

    /* SOLO MOSTRAR LOS QUE EST√ÅN EN COCINA O PREPARANDO */
    if(data.estado === "en_cocina" || data.estado === "preparando"){

      nuevos.push(d.id);

      contenedor.innerHTML += `
      <div class="card">
        <h3>Mesa ${data.mesa}</h3>
        <p><strong>Items:</strong><br>
          ${(data.items||[]).map(i=>`${i.prod} - $${i.precio}`).join("<br>")}
        </p>
        <p><strong>Nota:</strong> ${data.nota || "sin nota"}</p>
        <p><strong>Estado:</strong> ${data.estado}</p>

        <button class="preparando" onclick="preparando('${d.id}')">Preparando</button>
        <button class="listo" onclick="listo('${d.id}')">Listo</button>
      </div>`;
    }
  });

  /* SONIDO SOLO SI ENTRA UNO NUEVO */
  if(nuevos.length > pedidosActuales.length){
    sonido.play();
  }

  pedidosActuales = nuevos;
});

/* PASAR A PREPARANDO */
window.preparando = async (id) => {
  await updateDoc(doc(db,"pedidos",id),{
    estado:"preparando"
  });
};

/* PASAR A LISTO (DESAPARECE SOLO) */
window.listo = async (id) => {

  await updateDoc(doc(db,"pedidos",id),{
    estado:"listo"
  });

  document.body.style.background = "#0f8f0f";
  setTimeout(()=> document.body.style.background = "#050505", 1500);
};
</script>
</body>
</html>