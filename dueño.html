<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Dueño</title>

<style>
body{
  background:#050505;
  color:#f5d28a;
  font-family:Arial;
  padding:18px;
}

header{text-align:center;}

.logo{
  width:280px;
}

h1{
  margin-top:10px;
}

.card{
  background:#101010;
  border:1px solid #2b2b2b;
  border-radius:16px;
  padding:20px;
  margin:12px 0;
}

button{
  padding:14px 18px;
  border:none;
  border-radius:12px;
  background:linear-gradient(145deg, #8a6a2f, #5f4a1a);
  color:white;
  font-weight:bold;
  box-shadow:0 4px 12px rgba(138,106,47,0.6);
  margin:6px 0;
}

input[type=date]{
  padding:10px;
  border-radius:10px;
  border:1px solid #2b2b2b;
  background:#111;
  color:white;
  margin-bottom:10px;
}
</style>
</head>
<body>

<header>
  <img src="logo.png" class="logo">
  <h1>Panel Dueño</h1>
</header>

<!-- ESTADÍSTICAS -->
<div class="card">
  <h2>Hoy (<span id="fechaHoy"></span>)</h2>
  <p>Pedidos: <span id="pedidosHoy">0</span></p>
  <p>Cobrados: <span id="cobradosHoy">0</span></p>
  <p>Pagados: <span id="pagadosHoy">0</span></p>
  <p>Vendido: $<span id="vendidoHoy">0</span></p>
</div>

<!-- HISTORIAL -->
<div class="card">
  <h2>Historial</h2>
  <input type="date" id="filtroFecha">
  <button onclick="filtrarFecha()">Filtrar</button>
  <button onclick="mostrarHoy()">Hoy</button>
  <button onclick="limpiarDia()">Limpiar día (archivar pruebas)</button>
  <button onclick="exportarExcel()">Exportar Excel</button>

  <div id="historial"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"TU_API_KEY",
 authDomain:"menu-pro-app.firebaseapp.com",
 projectId:"menu-pro-app",
 storageBucket:"menu-pro-app.firebasestorage.app",
 messagingSenderId:"42917274964",
 appId:"1:42917274964:web:3be3c9c124b9c69b8994c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let fechaActual = new Date().toDateString();

/* CAMBIO AUTOMÁTICO DE DÍA (5AM) */
function checkCambioDia(){
  const ahora = new Date();
  if(ahora.getHours() >= 5 && fechaActual !== ahora.toDateString()){
    fechaActual = ahora.toDateString();
  }
}
setInterval(checkCambioDia, 60000);

/* ESTADÍSTICAS */
onSnapshot(collection(db,"pedidos"), snap=>{
  let pedidos = 0;
  let cobrados = 0;
  let pagados = 0;
  let vendido = 0;

  snap.forEach(d=>{
    const p = d.data();
    if(p.archivado) return;

    const fecha = new Date(p.createdAt.seconds*1000).toDateString();

    if(fecha === fechaActual){
      pedidos++;
      if(p.estado === "pagado") pagados++;
      if(p.estado === "pagado" || p.estado === "entregado") cobrados++;
      if(p.estado === "pagado" || p.estado === "entregado") vendido += p.total;
    }
  });

  document.getElementById("fechaHoy").innerText = fechaActual;
  document.getElementById("pedidosHoy").innerText = pedidos;
  document.getElementById("cobradosHoy").innerText = cobrados;
  document.getElementById("pagadosHoy").innerText = pagados;
  document.getElementById("vendidoHoy").innerText = vendido;
});

/* HISTORIAL */
function cargarHistorial(fecha){
  onSnapshot(collection(db,"pedidos"), snap=>{
    const h = document.getElementById("historial");
    h.innerHTML = "";

    snap.forEach(d=>{
      const p = d.data();
      if(p.archivado) return;

      const f = new Date(p.createdAt.seconds*1000).toDateString();
      if(fecha && f !== fecha) return;

      h.innerHTML += `
      <div class="card">
        <h3>Mesa ${p.mesa}</h3>
        <p>Total: $${p.total}</p>
        <p>Estado: ${p.estado}</p>
        <p>Fecha: ${new Date(p.createdAt.seconds*1000).toLocaleString()}</p>
      </div>`;
    });
  });
}

/* LIMPIAR DÍA (ARCHIVAR) */
window.limpiarDia = () => {
  if(!confirm("Limpiar día y archivar pruebas?")) return;

  onSnapshot(collection(db,"pedidos"), snap=>{
    snap.forEach(async d=>{
      const p = d.data();
      const fecha = new Date(p.createdAt.seconds*1000).toDateString();
      if(fecha === fechaActual){
        await updateDoc(doc(db,"pedidos", d.id),{
          archivado: true
        });
      }
    });
  });

  document.getElementById("historial").innerHTML = "";
  alert("Día archivado ✔");
};

/* EXPORT EXCEL */
window.exportarExcel = () => {
  let csv = "mesa,total,estado,fecha\n";

  onSnapshot(collection(db,"pedidos"), snap=>{
    snap.forEach(d=>{
      const p = d.data();
      if(p.archivado) return;
      const fecha = new Date(p.createdAt.seconds*1000).toLocaleString();
      csv += `${p.mesa},${p.total},${p.estado},${fecha}\n`;
    });

    const blob = new Blob([csv],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ventas.csv";
    a.click();
    URL.revokeObjectURL(url);
  });
};

/* FUNCIONES */
window.mostrarHoy = () => cargarHistorial(fechaActual);

window.filtrarFecha = () => {
  const f = document.getElementById("filtroFecha").value;
  if(!f) return;
  cargarHistorial(new Date(f).toDateString());
};

window.nuevoDia = () => {
  if(!confirm("Nuevo día?")) return;
  fechaActual = new Date().toDateString();
  document.getElementById("historial").innerHTML = "";
};

cargarHistorial(fechaActual);
</script>
</body>
</html>