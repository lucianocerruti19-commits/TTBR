<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Dueño</title>

<style>
body{
  background:#050505;
  color:#f5d28a;
  font-family:Arial;
  padding:18px;
}

header{text-align:center;}

.logo{width:280px;}

.grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:12px;
}

.card{
  background:#101010;
  border:1px solid #2b2b2b;
  border-radius:16px;
  padding:18px;
  font-size:18px;
}

button{
  padding:14px 18px;
  border:none;
  border-radius:12px;
  background:linear-gradient(145deg, #8a6a2f, #5f4a1a);
  color:white;
  font-weight:bold;
  box-shadow:0 4px 12px rgba(138,106,47,0.6);
  margin:6px 0;
  width:100%;
}

section{margin-top:20px;}

input[type=date]{
  padding:10px;
  border-radius:10px;
  border:1px solid #2b2b2b;
  background:#111;
  color:white;
}
</style>
</head>
<body>

<header>
  <img src="logo.png" class="logo">
  <h1>Panel Dueño</h1>
</header>

<!-- FILTRO -->
<section>
  <h3>Filtrar por fecha</h3>
  <input type="date" id="fechaFiltro">
  <button onclick="filtrarFecha()">Filtrar</button>
</section>

<!-- BOTONES -->
<section>
  <button onclick="limpiarDia()">Limpiar día</button>
  <button onclick="nuevoDia()">Nuevo día</button>
  <button onclick="exportarExcel()">Exportar Excel</button>
</section>

<!-- MÉTRICAS -->
<div class="grid">
  <div class="card">
    <h3>Pedidos</h3>
    <p>$<span id="pedidosTotal">0</span></p>
  </div>
  <div class="card">
    <h3>Cobrados</h3>
    <p>$<span id="cobradosTotal">0</span></p>
  </div>
  <div class="card">
    <h3>Pagados</h3>
    <p>$<span id="pagadosTotal">0</span></p>
  </div>
  <div class="card">
    <h3>Total vendido</h3>
    <p>$<span id="vendidoTotal">0</span></p>
  </div>
</div>

<!-- DETALLE -->
<section>
  <h2>Detalle</h2>
  <div id="historial"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCa-R6z76qoMt6Wf9EZFSqqGNY8U4JUMtM",
  authDomain: "menu-pro-app.firebaseapp.com",
  projectId: "menu-pro-app",
  storageBucket: "menu-pro-app.firebasestorage.app",
  messagingSenderId: "42917274964",
  appId: "1:42917274964:web:13e161810ad195718994c1"
};

const db = getFirestore(initializeApp(firebaseConfig));

let filtro = null;

/* ACTUALIZAR */
function actualizar(){
  onSnapshot(collection(db,"pedidos"), snap=>{
    let pedidos = 0;
    let cobrados = 0;
    let pagados = 0;
    let vendido = 0;
    let detalle = false;

    const cont = document.getElementById("historial");
    cont.innerHTML = "";

    snap.forEach(d=>{
      const p = d.data();
      if(p.archivado) return;

      const fecha = p.createdAt?.seconds
        ? new Date(p.createdAt.seconds*1000)
        : null;

      const fDia = fecha ? fecha.toDateString() : "";

      if(filtro && fDia !== filtro) return;

      detalle = true;
      pedidos += p.total || 0;

      if(p.estado === "pagado") {
        pagados += p.total || 0;
        cobrados += p.total || 0;
        vendido += p.total || 0;
      } else if(p.estado === "entregado") {
        cobrados += p.total || 0;
        vendido += p.total || 0;
      }

      cont.innerHTML += `
        <div class="card">
          <h3>Mesa ${p.mesa || "?"}</h3>
          <p>Total: $${p.total || 0}</p>
          <p>Estado: ${p.estado || "sin estado"}</p>
          <p>Fecha: ${fecha ? fecha.toLocaleString() : "sin fecha"}</p>
          <p>Items:<br>${(p.items||[]).map(i=>`${i.prod} - $${i.precio}`).join("<br>")}</p>
        </div>`;
    });

    if(!detalle){
      cont.innerHTML = `
        <div class="card">
          <h3>No hay ventas</h3>
          <p>Pedidos: $0</p>
        </div>`;
    }

    document.getElementById("pedidosTotal").innerText = pedidos;
    document.getElementById("cobradosTotal").innerText = cobrados;
    document.getElementById("pagadosTotal").innerText = pagados;
    document.getElementById("vendidoTotal").innerText = vendido;
  });
}

/* FILTRAR */
window.filtrarFecha = () => {
  const f = document.getElementById("fechaFiltro").value;
  if(!f) return;
  filtro = new Date(f).toDateString();
  actualizar();
};

/* LIMPIAR (archiva) */
window.limpiarDia = () => {
  if(!confirm("Limpiar día?")) return;

  onSnapshot(collection(db,"pedidos"), snap=>{
    snap.forEach(async d=>{
      const p = d.data();
      const fecha = p.createdAt?.seconds
        ? new Date(p.createdAt.seconds*1000).toDateString()
        : "";

      if(fecha === new Date().toDateString()){
        await updateDoc(doc(db,"pedidos", d.id),{
          archivado: true
        });
      }
    });
  });

  document.getElementById("historial").innerHTML = "";
};

/* NUEVO DÍA */
window.nuevoDia = () => {
  filtro = null;
  document.getElementById("fechaFiltro").value = "";

  document.getElementById("pedidosTotal").innerText = 0;
  document.getElementById("cobradosTotal").innerText = 0;
  document.getElementById("pagadosTotal").innerText = 0;
  document.getElementById("vendidoTotal").innerText = 0;

  document.getElementById("historial").innerHTML = `
    <div class="card">
      <h3>Nuevo día</h3>
      <p>Pedidos: $0</p>
    </div>`;
};

/* EXPORT EXCEL */
window.exportarExcel = () => {
  let csv = "mesa,total,estado,fecha,items\n";

  onSnapshot(collection(db,"pedidos"), snap=>{
    snap.forEach(d=>{
      const p = d.data();
      if(p.archivado) return;

      const fecha = p.createdAt?.seconds
        ? new Date(p.createdAt.seconds*1000).toLocaleString()
        : "";

      const items = (p.items||[]).map(i=>`${i.prod}-${i.precio}`).join("|");

      csv += `${p.mesa},${p.total},${p.estado},${fecha},${items}\n`;
    });

    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ventas.csv";
    a.click();
  });
};

actualizar();
</script>
</body>
</html>