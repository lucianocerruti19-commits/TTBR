<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Due√±o - Sistema Profesional</title>

<style>
body{
  background:#050505;
  color:#f5d28a;
  font-family:Arial;
  padding:20px;
}

h1{text-align:center;margin-bottom:20px;}

.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin-bottom:25px;
}

.card{
  background:#101010;
  border:1px solid #2b2b2b;
  border-radius:16px;
  padding:18px;
}

.big{
  font-size:22px;
  font-weight:bold;
}

button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:linear-gradient(145deg,#d8b14a,#b58c2f);
  color:black;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}

canvas{max-width:100%;}
</style>
</head>
<body>

<h1>Panel Due√±o Profesional</h1>

<div class="dashboard">
  <div class="card"><div>üí∞ Vendido Hoy</div><div class="big">$<span id="vendidoHoy">0</span></div></div>
  <div class="card"><div>üíµ Cobrado Hoy</div><div class="big">$<span id="cobradoHoy">0</span></div></div>
  <div class="card"><div>üì¶ Pedidos Hoy</div><div class="big"><span id="pedidosHoy">0</span></div></div>
  <div class="card"><div>üî• En Cocina</div><div class="big"><span id="enCocina">0</span></div></div>
  <div class="card"><div>üçΩ Listos</div><div class="big"><span id="listos">0</span></div></div>
  <div class="card"><div>üßæ Pagados</div><div class="big"><span id="pagados">0</span></div></div>
</div>

<div class="card">
  <h2>Ventas √∫ltimos 7 d√≠as</h2>
  <canvas id="chart"></canvas>
</div>

<div class="card">
  <h2>Historial Activo</h2>
  <button onclick="cerrarDia()">üîí Cerrar D√≠a</button>
  <div id="historial"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"TU_API_KEY",
 authDomain:"menu-pro-app.firebaseapp.com",
 projectId:"menu-pro-app",
 storageBucket:"menu-pro-app.firebasestorage.app",
 messagingSenderId:"42917274964",
 appId:"1:42917274964:web:3be3c9c124b9c69b8994c1"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let chart;

onSnapshot(collection(db,"pedidos"), snap=>{

  let vendidoHoy=0;
  let cobradoHoy=0;
  let pedidosHoy=0;
  let enCocina=0;
  let listos=0;
  let pagados=0;

  let ventasPorDia={};
  const hoyStr=new Date().toDateString();
  const historial=document.getElementById("historial");
  historial.innerHTML="";

  snap.forEach(d=>{
    const p=d.data();
    if(!p.createdAt) return;

    const fecha=new Date(p.createdAt.seconds*1000);
    const fechaStr=fecha.toDateString();

    if(fechaStr===hoyStr){
      pedidosHoy++;
      vendidoHoy+=p.total||0;

      if(p.estado==="pagado") cobradoHoy+=p.total||0;
    }

    if(p.estado==="en_cocina") enCocina++;
    if(p.estado==="listo") listos++;
    if(p.estado==="pagado") pagados++;

    // gr√°fico
    const key=fechaStr;
    if(!ventasPorDia[key]) ventasPorDia[key]=0;
    if(p.estado==="pagado") ventasPorDia[key]+=p.total||0;

    // historial activo (no cerrados)
    if(p.estado!=="cerrado"){
      historial.innerHTML+=`
      <div class="card">
        <strong>Mesa:</strong> ${p.mesa}<br>
        <strong>Total:</strong> $${p.total}<br>
        <strong>Estado:</strong> ${p.estado}<br>
        <strong>Mozo Cobr√≥:</strong> ${p.mozoCobro||"-"}<br>
        <strong>Fecha:</strong> ${fecha.toLocaleString()}<br>
        <strong>Items:</strong><br>
        ${(p.items||[]).map(i=>`${i.prod} - $${i.precio}`).join("<br>")}
      </div>`;
    }
  });

  document.getElementById("vendidoHoy").innerText=vendidoHoy;
  document.getElementById("cobradoHoy").innerText=cobradoHoy;
  document.getElementById("pedidosHoy").innerText=pedidosHoy;
  document.getElementById("enCocina").innerText=enCocina;
  document.getElementById("listos").innerText=listos;
  document.getElementById("pagados").innerText=pagados;

  actualizarGrafico(ventasPorDia);
});

function actualizarGrafico(data){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();

  const labels=Object.keys(data).slice(-7);
  const values=Object.values(data).slice(-7);

  chart=new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[{label:"Ventas",data:values}]
    }
  });
}

window.cerrarDia=async()=>{
  if(!confirm("Cerrar d√≠a actual?")) return;

  onSnapshot(collection(db,"pedidos"), snap=>{
    snap.forEach(async d=>{
      const p=d.data();
      if(p.estado==="pagado"){
        await updateDoc(doc(db,"pedidos",d.id),{
          estado:"cerrado"
        });
      }
    });
  });

  alert("D√≠a cerrado correctamente ‚úî");
};
</script>
</body>
</html>