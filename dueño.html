<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dueño</title>
<style>
body{
  background:#000;
  color:#d4af37;
  font-family:Arial;
  padding:15px;
}
section{margin-bottom:20px;}
button{
  padding:10px;
  border:none;
  border-radius:8px;
  background:#d4af37;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<h1>Dueño</h1>

<div>
  <button onclick="sonido(); mostrar('ventas')">Ventas</button>
  <button onclick="sonido(); mostrar('mozos')">Ventas por mozo</button>
  <button onclick="sonido(); mostrar('historial')">Historial</button>
  <button onclick="sonido(); apagarSonido()">Apagar sonido</button>
</div>

<section id="ventas">
  <h2>Totales</h2>
  <p id="totalHoy"></p>
  <p id="totalMes"></p>
</section>

<section id="mozos" style="display:none">
  <h2>Ventas por mozo</h2>
  <div id="ventasMozos"></div>
</section>

<section id="historial" style="display:none">
  <h2>Historial</h2>
  <input type="date" id="filtro">
  <button onclick="filtrar()">Filtrar</button>
  <button onclick="borrarHistorial()">Borrar historial</button>
  <div id="lista"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={/* tu config */};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let cache=[];

function sonido(){
  new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
}

window.apagarSonido=()=>{};

/* HISTORIAL */
onSnapshot(collection(db,"pedidos"),snap=>{
  cache=[];
  snap.forEach(d=>cache.push({...d.data(), id:d.id}));
  mostrarLista(cache);
});

function mostrarLista(list){
  const l=document.getElementById("lista");
  l.innerHTML="";

  list.forEach(p=>{
    const fecha=new Date(p.createdAt.seconds*1000);
    l.innerHTML+=`
    <div>
      Mesa ${p.mesa}<br>
      Mozo ${p.mozo}<br>
      Cobró ${p.mozoCobro || "sin dato"}<br>
      Total $${p.total}<br>
      Nota ${p.nota || "sin nota"}<br>
      Fecha ${fecha.toLocaleString()}
    </div><hr>`;
  });

  // ventas por mozo
  const por={};
  cache.forEach(p=>por[p.mozo]=(por[p.mozo]||0)+p.total);

  const vm=document.getElementById("ventasMozos");
  vm.innerHTML="";
  Object.keys(por).forEach(m=>{
    vm.innerHTML+=`${m}: $${por[m]}<br>`;
  });

  // totales
  const hoy=new Date().toDateString();
  let th=0,tm=0;
  cache.forEach(p=>{
    const f=new Date(p.createdAt.seconds*1000).toDateString();
    if(f===hoy) th+=p.total;
    tm+=p.total;
  });
  document.getElementById("totalHoy").innerText="Hoy: $"+th;
  document.getElementById("totalMes").innerText="Total: $"+tm;
}

window.filtrar=()=>{
  const f=document.getElementById("filtro").value;
  if(!f) return;
  const filtrados=cache.filter(p=>{
    const fecha=new Date(p.createdAt.seconds*1000)
      .toISOString().split("T")[0];
    return fecha===f;
  });
  mostrarLista(filtrados);
};

window.borrarHistorial=async()=>{
  if(!confirm("Borrar historial?")) return;
  cache.forEach(async p=>{
    await deleteDoc(doc(db,"pedidos",p.id));
  });
};

window.mostrar=id=>{
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};
</script>
</body>
</html>